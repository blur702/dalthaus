<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Lightbox Functionality</title>
    <script src="/tinymce/tinymce.min.js"></script>
</head>
<body>
    <h1>Test TinyMCE Lightbox Plugin</h1>
    
    <div style="margin: 20px;">
        <h2>Instructions:</h2>
        <ol>
            <li>Look for the "lightbox" button in the toolbar (should appear after the image button)</li>
            <li>Insert an image first using the image button</li>
            <li>Select the image and click the lightbox button</li>
            <li>Upload or specify a different/larger image for the lightbox</li>
        </ol>
    </div>
    
    <textarea id="tinymce-editor" style="width: 100%; height: 400px;">
        <h2>Test Content</h2>
        <p>Click the image button to insert an image, then select it and use the lightbox button.</p>
        <p>The lightbox button should appear in the toolbar next to the image button.</p>
    </textarea>

    <script>
        // Initialize TinyMCE with lightbox plugin
        tinymce.init({
            selector: '#tinymce-editor',
            license_key: 'gpl',
            height: 500,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'wordcount', 'pagebreak', 'lightboximage'
            ],
            toolbar: 'undo redo | blocks | ' +
                'bold italic forecolor | alignleft aligncenter ' +
                'alignright alignjustify | bullist numlist outdent indent | ' +
                'link image lightboximage media | pagebreak | removeformat | code',
            automatic_uploads: true,
            images_upload_handler: function (blobInfo, progress) {
                return new Promise((resolve, reject) => {
                    const formData = new FormData();
                    formData.append('image', blobInfo.blob(), blobInfo.filename());

                    const token = localStorage.getItem('token');
                    
                    fetch('/api/upload/image', {
                        method: 'POST',
                        headers: {
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.url || result.imageUrl) {
                            resolve(result.url || result.imageUrl);
                        } else {
                            reject('Upload failed');
                        }
                    })
                    .catch(error => {
                        reject(error);
                    });
                });
            },
            setup: function(editor) {
                // Initialize lightbox plugin BEFORE editor init
                if (typeof tinymce !== 'undefined' && tinymce.PluginManager) {
                    // Import and initialize lightbox plugin
                    if (!tinymce.PluginManager.get('lightboximage')) {
                        // Register the lightbox plugin inline
                        tinymce.PluginManager.add('lightboximage', function(editor) {
                            
                            // Add button to toolbar
                            editor.ui.registry.addButton('lightboximage', {
                                icon: 'image',
                                tooltip: 'Set Lightbox Image (Full Resolution)',
                                onAction: function() {
                                    const selectedNode = editor.selection.getNode();
                                    
                                    if (selectedNode && selectedNode.nodeName === 'IMG') {
                                        alert('Lightbox functionality works! Selected image: ' + selectedNode.src);
                                    } else {
                                        editor.notificationManager.open({
                                            text: 'Please select an image first, then assign its lightbox version',
                                            type: 'warning',
                                            timeout: 5000
                                        });
                                    }
                                }
                            });
                        });
                    }
                }
                
                editor.on('init', function() {
                    console.log('TinyMCE initialized with plugins:', editor.settings.plugins);
                    console.log('Toolbar config:', editor.settings.toolbar);
                });
            }
        });
    </script>
</body>
</html>